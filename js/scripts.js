const chicos = [
    {
        "name": "Roty",
        "region": "ciudad evita",
        "trabaja": "no",
        "pelo": "si",
        "color_de_piel": "blanco",
        "habilidad_lol": "bueno",
        "habilidad_cs": "malo",
        "es_gil": "si",
        "lore": "roba novias"
    },
    {
        "name": "Ima",
        "region": "avellaneda",
        "trabaja": "si",
        "pelo": "si",
        "color_de_piel": "blanquisimo",
        "habilidad_lol": "bueno",
        "habilidad_cs": "malo",
        "es_gil": "si",
        "lore": "no se sabe si es pelado"
    },
    {
        "name": "Kener",
        "region": "rosario",
        "trabaja": "no",
        "pelo": "si",
        "color_de_piel": "blanquisimo",
        "habilidad_lol": "malo",
        "habilidad_cs": "bueno",
        "es_gil": "si",
        "lore": "el nene en la nena"
    },
    {
        "name": "Juanma",
        "region": "cordoba",
        "trabaja": "si",
        "pelo": "no",
        "color_de_piel": "blanco",
        "habilidad_lol": "bueno",
        "habilidad_cs": "malo",
        "es_gil": "no",
        "lore": "bruiser"
    },
    {
        "name": "Eri",
        "region": "caseros",
        "trabaja": "si",
        "pelo": "no",
        "color_de_piel": "blanco",
        "habilidad_lol": "bueno",
        "habilidad_cs": "malo",
        "es_gil": "si",
        "lore": "milf"
    },
    {
        "name": "Crilzo",
        "region": "porteño",
        "trabaja": "si",
        "pelo": "si",
        "color_de_piel": "blanco",
        "habilidad_lol": "malo",
        "habilidad_cs": "malo",
        "es_gil": "no",
        "lore": "bizco"
    },
    {
        "name": "Calippy",
        "region": "el void",
        "trabaja": "no",
        "pelo": "si",
        "color_de_piel": "blanco",
        "habilidad_lol": "malo",
        "habilidad_cs": "malo",
        "es_gil": "no",
        "lore": "crazy taco"
    },
    {
        "name": "Fede",
        "region": "mar del plata",
        "trabaja": "si",
        "pelo": "si",
        "color_de_piel": "blanco",
        "habilidad_lol": "average",
        "habilidad_cs": "bueno",
        "es_gil": "no",
        "lore": "buena ceja"
    },
    {
        "name": "Nabu",
        "region": "san martin",
        "trabaja": "si",
        "pelo": "si",
        "color_de_piel": "blanco",
        "habilidad_lol": "malo",
        "habilidad_cs": "average",
        "es_gil": "no",
        "lore": "ruido de encendedor"
    },
    {
        "name": "Dano",
        "region": "avellaneda",
        "trabaja": "si",
        "pelo": "si",
        "color_de_piel": "blanco",
        "habilidad_lol": "average",
        "habilidad_cs": "bueno",
        "es_gil": "no",
        "lore": "maestro splinter"
    },
    {
        "name": "Sighma",
        "region": "jose c paz",
        "trabaja": "si",
        "pelo": "si",
        "color_de_piel": "blanco",
        "habilidad_lol": "average",
        "habilidad_cs": "malo",
        "es_gil": "si",
        "lore": "ilegal es poco"
    },
    {
        "name": "Agu",
        "region": "mar del plata",
        "trabaja": "no",
        "pelo": "no",
        "color_de_piel": "blanco",
        "habilidad_lol": "bueno",
        "habilidad_cs": "bueno",
        "es_gil": "si",
        "lore": "es buen loco"
    },
    {
        "name": "Pani",
        "region": "mar del plata",
        "trabaja": "si",
        "pelo": "si",
        "color_de_piel": "marronazo",
        "habilidad_lol": "malo",
        "habilidad_cs": "malo",
        "es_gil": "no",
        "lore": "se pinta las uñas y le entra a la prima"
    },
    {
        "name": "Dolla",
        "region": "ciudad evita",
        "trabaja": "si",
        "pelo": "si",
        "color_de_piel": "blanco",
        "habilidad_lol": "malo",
        "habilidad_cs": "malo",
        "es_gil": "si",
        "lore": "chicito"
    },
    {
        "name": "Chiru",
        "region": "ciudad evita",
        "trabaja": "si",
        "pelo": "si",
        "color_de_piel": "blanco",
        "habilidad_lol": "malo",
        "habilidad_cs": "malo",
        "es_gil": "no",
        "lore": "tremendo autista"
    },
    {
        "name": "Tito",
        "region": "ciudad evita",
        "trabaja": "si",
        "pelo": "si",
        "color_de_piel": "blanco",
        "habilidad_lol": "malo",
        "habilidad_cs": "bueno",
        "es_gil": "si",
        "lore": "casi muere"
    },
    {
        "name": "Dyrude",
        "region": "ciudad evita",
        "trabaja": "si",
        "pelo": "si",
        "color_de_piel": "morocho",
        "habilidad_lol": "malo",
        "habilidad_cs": "malo",
        "es_gil": "no",
        "lore": "esta mimosho"
    },
    {
        "name": "Pioox",
        "region": "wilde",
        "trabaja": "si",
        "pelo": "si",
        "color_de_piel": "blanco",
        "habilidad_lol": "bueno",
        "habilidad_cs": "malo",
        "es_gil": "no",
        "lore": "le re cuesta"
    },
    {
        "name": "Ficha",
        "region": "dominico",
        "trabaja": "si",
        "pelo": "si",
        "color_de_piel": "blanco",
        "habilidad_lol": "bueno",
        "habilidad_cs": "malo",
        "es_gil": "si",
        "lore": "acido"
    },
    {
        "name": "Kevin recke",
        "region": "caseros",
        "trabaja": "si",
        "pelo": "si",
        "color_de_piel": "blanco",
        "habilidad_lol": "average",
        "habilidad_cs": "bueno",
        "es_gil": "si",
        "lore": "fajaba a la jermu"
    },
    {
        "name": "Gmauro",
        "region": "ciudad evita",
        "trabaja": "si",
        "pelo": "si",
        "color_de_piel": "blanco",
        "habilidad_lol": "malo",
        "habilidad_cs": "average",
        "es_gil": "no",
        "lore": "gmauro"
    },
    {
        "name": "Mosta",
        "region": "mar del plata",
        "trabaja": "si",
        "pelo": "si",
        "color_de_piel": "morocho",
        "habilidad_lol": "malo",
        "habilidad_cs": "malo",
        "es_gil": "no",
        "lore": "tartamudea cuando se pone nervioso"
    },
    {
        "name": "Nicuco",
        "region": "mar del plata",
        "trabaja": "si",
        "pelo": "si",
        "color_de_piel": "blanco",
        "habilidad_lol": "malo",
        "habilidad_cs": "malo",
        "es_gil": "no",
        "lore": "el terror de chicos y grandes"
    },
    {
        "name": "Wailler",
        "region": "ciudad evita",
        "trabaja": "si",
        "pelo": "si",
        "color_de_piel": "blanco",
        "habilidad_lol": "malo",
        "habilidad_cs": "malo",
        "es_gil": "si",
        "lore": "no se calla nunca"
    },
    {
        "name": "kIRAX",
        "region": "wilde",
        "trabaja": "si",
        "pelo": "si",
        "color_de_piel": "blanco",
        "habilidad_lol": "malo",
        "habilidad_cs": "bueno",
        "es_gil": "si",
        "lore": "es facho"
    },
    {
        "name": "Fran",
        "region": "olavarria",
        "trabaja": "si",
        "pelo": "si",
        "color_de_piel": "blanco",
        "habilidad_lol": "malo",
        "habilidad_cs": "malo",
        "es_gil": "no",
        "lore": "dejo los souls para dedicarse a su falcon verde"
    }
];
const frases_chicos = [
{
   "name":"Roty",
   "frases":[
      "Te puse",
      "Tas jugando de reojo maxi, eh, la concha de tu madre"
   ]
},
{
   "name":"Ima",
   "frases":[
      "Segui ehg"
   ]
},
{
   "name":"Kener",
   "frases":[
      "Hijo de pootaah",
      "Yo no me garcho a nadie.. mi jermu me mira",
      "Puerta abierta",
      "El tio carlo",
      "Chogur con copos"
   ]
},
{
   "name":"Juanma",
   "frases":[
      "Vo so loco o te hace",
      "Eri pli",
      "Eee medio ct b cache",
      "Tio carlo???"
   ]
},
{
   "name":"Eri",
   "frases":[
      "Y la novia para cuando?",
      "Vo le cree"
   ]
},
{
   "name":"Crilzo",
   "frases":[
      "Nino vimo chico"
   ]
},
{
   "name":"Calippy",
   "frases":[
      "OugHhHGHHhHhgg"
   ]
},
{
   "name":"Fede",
   "frases":[
      "Palermitano de mierda"
   ]
},
{
   "name":"Nabu",
   "frases":[
      "Es todo porro, no tiene filtro"
   ]
},
{
   "name":"Dano",
   "frases":[
      "Si apuntas mejor, si tenes mas armas, si te moves mas y si matas mas, tenes mas chances de ganar",
      "Pichon",
      "Depue te plico"
   ]
},
{
   "name":"Pani",
   "frases":[
      "Ciego te vas a quedar de tanta droga, enfermo",
      "Y el mono? el mono esta en tu culo"
   ]
},
{
   "name":"Dolla",
   "frases":[
      "Con vos? no gracia",
      "Timagina",
      "Yo nunca te vi"
   ]
},
{
   "name":"Pioox",
   "frases":[
      "Hola amor? donde estas? manda foto"
   ]
},
{
   "name":"Ficha",
   "frases":[
      "Estas re acido.",
      "Si no es con empatia, no es humor."
   ]
},
{
   "name":"Mosta",
   "frases":[
      "Hijaaaaaa de putaaaa *se larga a llorar*"
   ]
},
{
   "name":"Nicuco",
   "frases":[
      "Ahora....No te puedo.....Explicar..."
   ]
},
{
   "name":"Tito",
   "frases":[
      "Jefe, hoy no voy",
      "Que tan enfermo tenes que estar para violar a un hombre?"
   ]
},
{
   "name":"Wailler",
   "frases":[
      "Fue fue fue",
      "Ehh?ahhh",
      "Te calentaste"
   ]
},
{
   "name":"Mono",
   "frases":[
      "Como se llama la partida?"
   ]
},
{
   "name":"Fatima, hermana de nabu",
   "frases":[
      "Yo tambien uso el ak para matar"
   ]
}]
const emojis_chicos = [

    {
        "name" : "Ima",
        "icons": ["🫦","🧑‍🦲","🤑"]
    },{
        "name" : "Dano",
        "icons": ["🐀","💸"]
    },{
        "name" : "Sighma",
        "icons": ["🏦","🏋️","📹"]
    },{
        "name" : "Pani",
        "icons": ["🤓","💅🏻","☝🏾","👨🏾‍🏫 ","😮‍💨"]
    },{
        "name" : "Agu",
        "icons": ["🏋️","💅🏻","👨‍🦲 ","🇩🇪"]
    },{
        "name" : "Nabu",
        "icons": ["❄️","🌱","👃"]
    },{
        "name" : "Fede",
        "icons": ["📢","🦮","🤨"]
    },{
        "name" : "Roty",
        "icons": ["🍜","😷","😮‍💨"]
    },{
        "name" : "Wailer",
        "icons": ["🏋️","🏍️"]
    },{
        "name" : "Nico",
        "icons": ["😡","☠️"]
    },{
        "name" : "Pioox",
        "icons": ["😡","🏹"]
    },{
        "name" : "Mosta",
        "icons": ["🛠️","💔 ","🔩","🇺🇦"]
    },{
        "name" : "Kener",
        "icons": ["🥷","👱🏻"]
    },{
        "name" : "Mati",
        "icons": ["🦷","🥰","🥭","🧸 "]
    },{
        "name" : "Tito",
        "icons": ["🍫"]
    }
]

const question_mark = "❓";


var datatable;
var datatableFrase;
var datatableEmoji;


// Returns a unique item from a list each day of the year - Deterministic
function getElegidoParaFecha(chicos, fecha, offset = 0) {
  const today = fecha;

  // Get the day of the year (1-365 or 366)
  const start = new Date(today.getFullYear(), 0, 0);
  const diff = today - start;
  const oneDay = 1000 * 60 * 60 * 24;
  const dayOfYear = Math.floor(diff / oneDay);

  // Simple seed-like approach using the dayOfYear
  const seed = dayOfYear + offset;

  // Use the seed to get a "random" index
  const index = seed % chicos.length;

  // Return the item from the list
  return chicos[index];
}


const elegido = getElegidoParaFecha(chicos, new Date())
const elegido_frase = getElegidoParaFecha(frases_chicos, new Date(), 10)
const frase_hoy = getElegidoParaFecha(elegido_frase['frases'], new Date(), 10)
const elegido_emoji = getElegidoParaFecha(emojis_chicos, new Date(), 20);
var intentos_emoji = 0;

var ultima_row = "";


function initializeAutocomplete() {
    const chicosArray = chicos.map(chico => {
        return {
            label: chico.name,
            value: chico
        };
    });

    $('#autocomplete').autocomplete({
        source: chicosArray,
        lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
            var re = new RegExp('\\b' + $.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
            return re.test(suggestion.value);
        },
        select: function (event, ui) {
            event.preventDefault();

            // Make the search bar empty
            $('#autocomplete').val("")

            // Add the row to the table
            addRowGuessAutista(ui.item.value)
        },
    });

    const chicosFrasesArray = frases_chicos.map(chico => {
        return {
            label: chico.name,
            value: chico
        };
    });

    $('#autocomplete_frase').autocomplete({
        source: chicosFrasesArray,
        lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
            var re = new RegExp('\\b' + $.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
            return re.test(suggestion.value);
        },
        select: function (event, ui) {
            event.preventDefault();

            // Make the search bar empty
            $('#autocomplete_frase').val("")

            // Add the row to the table
            addRowGuessFrase(ui.item.value)
        },
    });

    const chicosEmojiArray = emojis_chicos.map(chico => {
        return {
            label: chico.name,
            value: chico
        };
    });

    $('#autocomplete_emoji').autocomplete({
        source: chicosEmojiArray,
        lookupFilter: function (suggestion, originalQuery, queryLowerCase) {
            var re = new RegExp('\\b' + $.Autocomplete.utils.escapeRegExChars(queryLowerCase), 'gi');
            return re.test(suggestion.value);
        },
        select: function (event, ui) {
            event.preventDefault();

            // Make the search bar empty
            $('#autocomplete_emoji').val("")

            // Add the row to the table
            addRowGuessEmoji(ui.item.value)
        },
    });
}

function initializeGuessTable() {
    return new DataTable('#guesstable', {
        info: false,
        ordering: false,
        paging: false,
        searching: false,
        rowCallback: function(row, data, index) {
          rowCallback(row, data, index);
        }
    });
}

function initializeGuessTableFrase() {
    return new DataTable('#guesstable_frase', {
        info: false,
        ordering: false,
        paging: false,
        searching: false,
        rowCallback: function(row, data, index) {
          rowCallbackFrase(row, data, index);
        }
    });
}

function initializeGuessTableEmoji() {
    return new DataTable('#guesstable_emoji', {
        info: false,
        ordering: false,
        paging: false,
        searching: false,
        rowCallback: function(row, data, index) {
            if (ultima_row_emoji != row) { // Para evitar callbacks llamados dos veces
                ultima_row_emoji = row;
                rowCallbackEmoji(row, data, index);
            }
        }
    });
}

function verify(expected, actual, row, idx) {
    if (expected == actual) {
        $(row).find('td:eq(' + idx + ')').css('background-color', 'green');
        return true;
    } else {
        $(row).find('td:eq(' + idx + ')').css('background-color', 'red');
        return false;
    }
}

function rowCallback(row, data, index) {
    let nombre = data[0];
    let region = data[1];
    let trabaja = data[2];
    let pelo = data[3];
    let colorPiel = data[4];
    let lol = data[5];
    let cs = data[6];
    let gil = data[7];

    verify(nombre, elegido['name'], row, 0);
    verify(region, elegido['region'], row, 1);
    verify(trabaja, elegido['trabaja'], row, 2);
    verify(pelo, elegido['pelo'], row, 3);
    verify(colorPiel, elegido['color_de_piel'], row, 4);
    verify(lol, elegido['habilidad_lol'], row, 5);
    verify(cs, elegido['habilidad_cs'], row, 6);
    verify(gil, elegido['es_gil'], row, 7);
}

function rowCallbackFrase(row, data, index) {
    let nombre = data[0];
    verify(nombre, elegido_frase['name'], row, 0);
}

function rowCallbackEmoji(row, data, index) {
    let nombre = data[0];
    let asserted = verify(nombre, elegido_emoji['name'], row, 0);
    if (!asserted) {
        intentos_emoji++;
        drawEmojis();
    }

}

function addRowGuessAutista(chico) {
    $("#guesstable").show();
    $("#guesstable_parent").show();


    datatable
        .row
        .add([
            chico['name'],
            chico['region'],
            chico['trabaja'],
            chico['pelo'],
            chico['color_de_piel'],
            chico['habilidad_lol'],
            chico['habilidad_cs'],
            chico['es_gil']
        ])
        .draw(false);
}

function addRowGuessFrase(chico) {
    $("#guesstable_frase").show();
    $("#guesstable_frase_parent").show();
    datatableFrase
        .row
        .add([
            chico['name']
        ])
        .draw(false);
}

function addRowGuessEmoji(chico) {
    $("#guesstable_emoji").show();
    $("#guesstable_emoji_parent").show();

    datatableEmoji
        .row
        .add([
            chico['name']
        ])
        .draw(false);
}

function getAutistaDeAyer() {
    var date = new Date();
    date.setDate(date.getDate() - 1);
    let elegidoAyer = getElegidoParaFecha(chicos, date)
    return "El autista de ayer fue " + elegidoAyer['name'];
}

function getFraseDeAyer() {
    var date = new Date();
    date.setDate(date.getDate() - 1);
    let elegidoAyer = getElegidoParaFecha(frases_chicos, date, 10)
    let fraseAyer =  getElegidoParaFecha(elegidoAyer['frases'], date, 10)
    return "Frase de ayer: " + fraseAyer;
}

function initializeEmojiGame() {
    var array_emojis = Array(elegido_emoji.icons.length).fill(question_mark);


    $("#emojis").text(array_emojis.join(' '))
}

function drawEmojis() {
    var array_emojis = Array(elegido_emoji.icons.length).fill(question_mark);

    for (let i = 0; i <= intentos_emoji; i++) {
        array_emojis[i] = elegido_emoji.icons[i]
    }

    $("#emojis").text(array_emojis.join(' '))
}

$(document).ready(function () {
    initializeAutocomplete();
    datatable = initializeGuessTable();
    datatableFrase = initializeGuessTableFrase();
    datatableEmoji = initializeGuessTableEmoji();

    $("#autista_de_ayer").text(getAutistaDeAyer());
    $("#frase_de_ayer").text(getFraseDeAyer());

    $("#frase_hoy").text(frase_hoy);

    initializeEmojiGame();
    drawEmojis();
})


function mostrarPista() {
    $("#pista").text(elegido['lore'])
}